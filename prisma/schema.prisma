generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("POSTGRES_PRISMA_URL")
  directUrl = env("POSTGRES_URL_NON_POOLING")
}

model User {
  id                Int                 @id @default(autoincrement())
  name              String
  email             String              @unique
  password          String
  role              String
  isPasswordChanged Boolean             @default(false)
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  teamId            Int?
  cases             Case[]
  dailyMetrics      DailyMetrics[]
  events            Event[]
  news              News[]
  notifications     Notification[]
  semanalMetrics    SemanalMetrics[]    @relation("TeamLeaderSemanalMetrics")
  tmoMetrics        TMOMetrics[]        @relation("TeamLeaderTMOMetrics")
  managedTeams      Team[]              @relation("ManagerToTeam")
  leadTeams         Team[]              @relation("TeamLeaderToTeam")
  trimestralMetrics TrimestralMetrics[] @relation("TeamLeaderTrimestralMetrics")
  team              Team?               @relation(fields: [teamId], references: [id])
  nomencladorChanges NomencladorChange[] // Nueva relación
}

model Team {
  id                Int                 @id @default(autoincrement())
  name              String
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  managerId         Int
  teamLeaderId      Int
  cases             Case[]
  dailyMetrics      DailyMetrics[]
  semanalMetrics    SemanalMetrics[]
  tmoMetrics        TMOMetrics[]
  manager           User                @relation("ManagerToTeam", fields: [managerId], references: [id])
  teamLeader        User                @relation("TeamLeaderToTeam", fields: [teamLeaderId], references: [id])
  trimestralMetrics TrimestralMetrics[]
  members           User[]
}

model DailyMetrics {
  id        Int      @id @default(autoincrement())
  date      DateTime
  nsp       Int
  q         Int
  nps       Int
  csat      Float
  ces       Float
  rd        Float
  userId    Int
  teamId    Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  team      Team     @relation(fields: [teamId], references: [id])
  user      User     @relation(fields: [userId], references: [id])
}

model TrimestralMetrics {
  id           Int      @id @default(autoincrement())
  name         String
  month        String
  qResp        Int
  nps          Int
  sat          Float
  rd           Float
  teamLeaderId Int
  teamId       Int
  createdAt    DateTime @default(now())
  team         Team     @relation(fields: [teamId], references: [id])
  teamLeader   User     @relation("TeamLeaderTrimestralMetrics", fields: [teamLeaderId], references: [id])
}

model SemanalMetrics {
  id           Int      @id @default(autoincrement())
  name         String
  week         String
  q            Int
  nps          Int
  csat         Float
  teamLeaderId Int
  teamId       Int
  createdAt    DateTime @default(now())
  team         Team     @relation(fields: [teamId], references: [id])
  teamLeader   User     @relation("TeamLeaderSemanalMetrics", fields: [teamLeaderId], references: [id])
}

model TMOMetrics {
  id           Int      @id @default(autoincrement())
  name         String
  qLlAtendidas Int
  tiempoACD    String
  acw          String
  hold         String
  ring         String
  tmo          String
  teamLeaderId Int
  teamId       Int
  createdAt    DateTime @default(now())
  team         Team     @relation(fields: [teamId], references: [id])
  teamLeader   User     @relation("TeamLeaderTMOMetrics", fields: [teamLeaderId], references: [id])
}

model Case {
  id                Int      @id @default(autoincrement())
  claimDate         DateTime
  startDate         DateTime
  withinSLA         Boolean
  caseNumber        String   @unique
  authorizationType String
  details           String
  status            String   @default("pending")
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  userId            Int
  teamId            Int
  team              Team     @relation(fields: [teamId], references: [id])
  user              User     @relation(fields: [userId], references: [id])
}

model Notification {
  id        Int      @id @default(autoincrement())
  message   String
  read      Boolean  @default(false)
  createdAt DateTime @default(now())
  userId    Int
  user      User     @relation(fields: [userId], references: [id])
}

model Event {
  id        Int      @id @default(autoincrement())
  title     String
  start     DateTime
  end       DateTime
  creatorId Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  creator   User     @relation(fields: [creatorId], references: [id])
}

model News {
  id        String   @id @default(cuid())
  date      DateTime
  status    String   @default("active")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  creatorId Int
  name      String
  url       String
  creator   User     @relation(fields: [creatorId], references: [id])
}

model Survey {
  id                Int      @id @default(autoincrement())
  moodRating       Float
  workEnvironment  Float
  personalWellbeing Float
  workLifeBalance  Float
  stressLevel      Float
  feedback         String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
}

// Nuevos modelos para nomencladores
model NomencladorNM {
  id            Int       @id @default(autoincrement())
  descripcion   String    @db.Text
  comoPedirse   String    @db.Text
  codigo        String    @unique
  observaciones String?   @db.Text
  isActive      Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  changes       NomencladorChange[] @relation("NomencladorChangeToNM")
  equivalentesNU NomencladorEquivalencia[] @relation("NMtoNU")
}

model NomencladorNU {
  id            Int       @id @default(autoincrement())
  descripcion   String    @db.Text
  comoPedirse   String    @db.Text
  codigo        String
  nucodigo      String
  observaciones String?   @db.Text
  isActive      Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  changes       NomencladorChange[] @relation("NomencladorChangeToNU")
  equivalentesNM NomencladorEquivalencia[] @relation("NMtoNU")

  @@unique([codigo, nucodigo])
}

// Modelo para mantener equivalencias entre nomencladores
model NomencladorEquivalencia {
  id          Int           @id @default(autoincrement())
  nmId        Int
  nuId        Int
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  nm          NomencladorNM @relation("NMtoNU", fields: [nmId], references: [id])
  nu          NomencladorNU @relation("NMtoNU", fields: [nuId], references: [id])

  @@unique([nmId, nuId])
}

// Modelo para tracking de cambios en nomencladores
// Actualización del modelo NomencladorChange con nombres únicos para las relaciones
model NomencladorChange {
  id            Int       @id @default(autoincrement())
  nomenclador   String    // "NM" o "NU"
  practiceId    Int       // ID de la práctica modificada
  field         String    // Campo modificado
  oldValue      String?   @db.Text
  newValue      String    @db.Text
  createdAt     DateTime  @default(now())
  modifiedBy    Int       // ID del usuario que realizó el cambio
  
  // Referencias con nombres únicos para los constraints
  user          User      @relation(fields: [modifiedBy], references: [id])
  nomencladorNM NomencladorNM? @relation("NomencladorChangeToNM", fields: [practiceId], references: [id], map: "NomencladorChange_practiceId_nm_fkey")
  nomencladorNU NomencladorNU? @relation("NomencladorChangeToNU", fields: [practiceId], references: [id], map: "NomencladorChange_practiceId_nu_fkey")

  @@index([practiceId])
  @@index([createdAt])
}

model CaseTracking {
  id          Int      @id @default(autoincrement())
  caseNumber  String   @unique
  action      String   // "Derivar" or "Cerrar"
  area        String?  // Null when action is "Cerrar"
  reason      String
  completed   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}